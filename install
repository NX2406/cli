#!/bin/bash

# ==================================================
#  CLIProxyAPI 一键部署脚本
#  Source: https://github.com/NX2406/cli
#  Powered by Docker Compose
# ==================================================

# --- 颜色配置 ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PLAIN='\033[0m'

# --- 基础配置 ---
INSTALL_DIR="/home/docker/cliproxyapi"
GITHUB_REPO="https://github.com/NX2406/cli"

# --- 必须以 Root 运行 ---
[[ $EUID -ne 0 ]] && echo -e "${RED}错误：请使用 root 用户运行此脚本！${PLAIN}" && exit 1

# --- 全局变量 ---
CMD=""
RELEASE=""
DOCKER_COMPOSE_CMD=""

# --- Logo 显示 ---
show_logo() {
    clear
    echo -e "${CYAN}"
    echo -e "   _______   __    ______                     _      "
    echo -e "  / ____/ | / /   / ____/___  ____  ________ ( )_____ "
    echo -e " / /    | |/ /   / / __/ __ \/ __ \/ ___/ _ \|// ___/ "
    echo -e "/ /___  |   /   / /_/ / /_/ / /_/ / /  /  __/ (__  )  "
    echo -e "\____/  |_|     \____/\____/\____/_/   \___/ /____/   "
    echo -e "${PLAIN}"
    echo -e "Repo: ${GITHUB_REPO}"
    echo -e "----------------------------------------------------"
}

# --- 1. 系统检测 ---
check_sys() {
    if [ -n "$CMD" ]; then return; fi
    echo -e "${BLUE}[INFO] 正在检查系统环境...${PLAIN}"
    
    if [[ -f /etc/redhat-release ]]; then
        CMD="yum"; RELEASE="centos"
    elif cat /etc/issue | grep -q -E -i "debian"; then
        CMD="apt-get"; RELEASE="debian"
    elif cat /etc/issue | grep -q -E -i "ubuntu"; then
        CMD="apt-get"; RELEASE="ubuntu"
    elif cat /etc/issue | grep -q -E -i "centos|red hat|redhat|alma|rocky"; then
        CMD="yum"; RELEASE="centos"
    else
        CMD="apt-get"; RELEASE="unknown"
    fi
}

# --- 2. 基础依赖安装 ---
install_base() {
    check_sys
    echo -e "${BLUE}[INFO] 正在安装基础依赖...${PLAIN}"
    if [ "$CMD" == "apt-get" ]; then
        $CMD update -y -q
        $CMD install -y curl wget tar sudo socat ca-certificates
    elif [ "$CMD" == "yum" ]; then
        $CMD makecache -y
        $CMD install -y curl wget tar sudo socat ca-certificates
    fi
}

# --- 3. Docker 环境处理 ---
install_docker() {
    echo -e "${BLUE}[INFO] 检测 Docker 环境...${PLAIN}"
    
    if ! command -v docker > /dev/null 2>&1; then
        echo -e "${YELLOW}[WARN] 未检测到 Docker，正在自动安装...${PLAIN}"
        curl -fsSL https://get.docker.com | bash
        systemctl enable docker
        systemctl start docker
    fi

    # 寻找 docker compose 命令
    if docker compose version > /dev/null 2>&1; then
        DOCKER_COMPOSE_CMD="docker compose"
    elif command -v docker-compose > /dev/null 2>&1; then
        DOCKER_COMPOSE_CMD="docker-compose"
    else
        echo -e "${YELLOW}[WARN] 尝试安装 Docker Compose 插件...${PLAIN}"
        $CMD install -y docker-compose-plugin || true
        DOCKER_COMPOSE_CMD="docker compose"
    fi
}

# --- 4. 部署核心 ---
deploy_app() {
    install_base
    install_docker

    show_logo
    echo -e "${GREEN}环境准备完毕，开始部署 CLIProxyAPI${PLAIN}"

    mkdir -p "$INSTALL_DIR"

    # --- 密钥设置 ---
    echo -e "------------------------------------------------"
    echo -e "${YELLOW}请设置管理面板密钥 (Secret Key)${PLAIN}"
    echo -e "------------------------------------------------"
    read -p "请输入密钥 (直接回车默认: setup-secret-key): " USER_KEY
    if [ -z "$USER_KEY" ]; then USER_KEY="setup-secret-key"; fi
    
    # 转义处理
    USER_KEY_ESCAPED="${USER_KEY//\\/\\\\}"
    USER_KEY_ESCAPED="${USER_KEY_ESCAPED//\"/\\\"}"

    # --- 生成配置文件 config.yaml ---
    cat > "${INSTALL_DIR}/config.yaml" <<EOF
host: "0.0.0.0"
port: 8317

tls:
  enable: false
  cert: ""
  key: ""

remote-management:
  allow-remote: true
  secret-key: "${USER_KEY_ESCAPED}"

commercial-mode: false
logging-to-file: true

quota-exceeded:
  switch-project: true
  switch-preview-model: true
EOF

    # --- 生成 docker-compose.yml ---
    # [FIX] 修正了镜像名称
    cat > "${INSTALL_DIR}/docker-compose.yml" <<EOF
services:
  cli-proxy-api:
    image: eceasy/cli-proxy-api:latest
    container_name: cli-proxy-api
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./config.yaml:/CLIProxyAPI/config.yaml
      - ./auths:/root/.cli-proxy-api
      - ./logs:/CLIProxyAPI/logs
EOF

    # --- 启动 ---
    mkdir -p "${INSTALL_DIR}/auths" "${INSTALL_DIR}/logs"
    cd "$INSTALL_DIR"
    
    echo -e "${BLUE}[INFO] 拉取镜像并启动...${PLAIN}"
    
    # 尝试清理旧容器（如果存在）
    $DOCKER_COMPOSE_CMD down >/dev/null 2>&1 || true

    $DOCKER_COMPOSE_CMD pull
    $DOCKER_COMPOSE_CMD up -d

    if [ $? -eq 0 ]; then
        show_logo
        IP=$(curl -s ifconfig.me || echo "你的IP")
        echo -e "${GREEN}安装成功！${PLAIN}"
        echo -e "------------------------------------------------"
        echo -e "管理面板: http://${IP}:8317/management.html"
        echo -e "管理密钥: ${YELLOW}(已隐藏)${PLAIN}"
        echo -e "安装路径: ${INSTALL_DIR}"
        echo -e "------------------------------------------------"
        echo -e "输入 ${CYAN}bash <(curl -sL https://raw.githubusercontent.com/NX2406/cli/main/install)${PLAIN} 可再次呼出菜单"
    else
        echo -e "${RED}[ERROR] 启动失败，请检查 Docker 日志。${PLAIN}"
    fi
}

# --- 5. 卸载逻辑 ---
uninstall_app() {
    install_docker
    read -p "确认卸载并删除所有数据？(y/n): " confirm
    if [[ "$confirm" == "y" ]]; then
        cd "$INSTALL_DIR" && $DOCKER_COMPOSE_CMD down
        rm -rf "$INSTALL_DIR"
        echo -e "${GREEN}卸载完成。${PLAIN}"
    fi
}

# --- 菜单 ---
show_menu() {
    show_logo
    echo -e "${GREEN}1.${PLAIN} 安装/重装 CLIProxyAPI"
    echo -e "${GREEN}2.${PLAIN} 更新应用"
    echo -e "${GREEN}3.${PLAIN} 卸载应用"
    echo -e "${GREEN}4.${PLAIN} 查看日志"
    echo -e "${GREEN}5.${PLAIN} 重启服务"
    echo -e "0. 退出"
    echo -e "------------------------------------------------"
    read -p "请选择: " choice

    case $choice in
        1) deploy_app ;;
        2) install_docker; cd "$INSTALL_DIR" && $DOCKER_COMPOSE_CMD pull && $DOCKER_COMPOSE_CMD up -d && echo -e "${GREEN}更新完毕${PLAIN}" ;;
        3) uninstall_app ;;
        4) install_docker; cd "$INSTALL_DIR" && $DOCKER_COMPOSE_CMD logs -f --tail=50 ;;
        5) install_docker; cd "$INSTALL_DIR" && $DOCKER_COMPOSE_CMD restart && echo -e "${GREEN}已重启${PLAIN}" ;;
        0) exit 0 ;;
        *) show_menu ;;
    esac
}

# 运行菜单
show_menu
